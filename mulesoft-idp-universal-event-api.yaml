asyncapi: 2.6.0
id: urn:mulesoft:com:idp:events
info:
  title: MuleSoft IDP Universal 🌐 Event API
  version: 1.0.0
  description: |-

    Powering Enterpise Scale IDP processing:
      - MuleSoft IDP Universal 🌐 Callback API
      - MuleSoft IDP Universal 🌐 REST Connector 🔌
      - MuleSoft IDP Universal 🌐 Process Application
      - MuleSoft IDP Universal 🌐 Event API

    
    [ Asyncapi Anypoint-specific MQ Bindings](https://github.com/asyncapi/bindings/tree/master/anypointmq).

    [ MuleSoft Blog - Event-Driven Architecture and API-Led Connectivity](https://blogs.mulesoft.com/dev-guides/event-driven-architecture-and-api-led-connectivity).

  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0

  termsOfService: https://www.UseAtYourOwnRisk.com

  contact:
    name: George Jeffcock
    url: https://www.lowcoders.com/
    email: george@lowcoders.com

externalDocs:
  description: specification/v2.6.0
  url: https://v2.asyncapi.com/docs/reference/specification/v2.6.0

defaultContentType: application/json

servers:
  anypoint-prd:
    url: anypointmq.server.anypoint-prd.url
    description: Anypoint MQ broker PRD Env
    protocol: anypointmq
    protocolVersion: v1
    tags:
      - name: env:production
        description: Anypoint MQ broker for production, in the US East (N. Virginia) runtime plane under management of the US control plane.
    security:
      - anypoint-oauth-prd: []
    

  anypoint-dev:
    url: anypointmq.server.anypoint-dev.url
    description: Anypoint MQ broker DEV Env
    protocol: anypointmq
    protocolVersion: v1
    tags:
      - name: env:development
        description: Anypoint MQ broker for development, in the US East (N. Virginia) runtime plane under management of the US control plane.
    security:
      - anypoint-oauth-dev: []

channels:
  mulesoft.idp.callback.v1:
    description: MuleSoft IDP platform executed a callback on the change of status of a processing doc so channel used to process returned notifcations (callbacks) from IDP
    servers:
      - anypoint-dev
      - anypoint-prd
    subscribe:
      operationId: mulesoft.idp.callback.send.v1
      description: Send (using asyncapi 3.0 Terminology) to Channel all IDP Callback Occurences
      summary: Send IDP Callback Event
      message:
        $ref: '#/components/messages/idpSubmissionKeys'
    publish:
      operationId: mulesoft.idp.callback.receive.v1
      description: Receive (using asyncapi 3.0 Terminology) all IDP callbacks Occurences
      summary: Receive IDP Callback Event
      message:
        $ref: '#/components/messages/idpSubmissionKeys'
    bindings:
      anypointmq:
        destination: idp
        destinationType: queue
        bindingVersion: latest


  
  mulesoft.idp.updated.status.{executionResult}.v1:
    description: |- 
      🏢 Enterprise will be interested in knowing MuleSoft IDP platform has processed a doc request but the result stopped due to **FAILED** or **MANUAL_VALIDATION_REQUIRED**

      🚨 BUT also more of a chance to show **parameters** in Async Apis ;) as this might actually be an anti-pattern  
      
      ## [Execution Results Reference](https://docs.mulesoft.com/idp/automate-document-processing-with-the-idp-api#execution-status-reference).

      - `ACKNOWLEDGED`: The document action execution request was received.
      - `IN_PROGRESS`: The execution started.
      - `RESULTS_PENDING`: The execution finished and IDP is processing the results.
      - `MANUAL_VALIDATION_REQUIRED`: The execution finished but the results need manual validation.
      - `FAILED`: The execution request finished unsuccessfully.
      - `PARTIAL_SUCCESS`: The execution request finished but some sub-tasks failed.
      - `SUCCEEDED`: The execution request finished successfully.

    parameters:
      executionResult:
        $ref: '#/components/parameters/executionResult'
    servers:
      - anypoint-dev
      - anypoint-prd
    subscribe:
      operationId: mulesoft.idp.updated.status.send.v1
      description: Send to Channel specfic IDP Status Changes
      summary: Send IDP Status Changes
      message:
        $ref: '#/components/messages/idpSubmissionKeys'
    publish:
      operationId: mulesoft.idp.updated.status.receive.v1
      description: Receive specfic IDP Status Changes
      summary: Receive IDP Status Changes
      message:
        $ref: '#/components/messages/idpSubmissionKeys'
    bindings:
      anypointmq:
#       destination: idp.status  No point as a parameter field makes it dynamic
        destinationType: fifo-queue
        bindingVersion: latest


components:

  parameters:
    executionResult:
      description: |- 
        ## [Execution Results Reference](https://docs.mulesoft.com/idp/automate-document-processing-with-the-idp-api#execution-status-reference).

        - `ACKNOWLEDGED`: The document action execution request was received.
        - `IN_PROGRESS`: The execution started.
        - `RESULTS_PENDING`: The execution finished and IDP is processing the results.
        - `MANUAL_VALIDATION_REQUIRED`: The execution finished but the results need manual validation.
        - `FAILED`: The execution request finished unsuccessfully.
        - `PARTIAL_SUCCESS`: The execution request finished but some sub-tasks failed.
        - `SUCCEEDED`: The execution request finished successfully.
      schema:
        type: string
        description: lowercase and no special characters as to channel convention
        enum:
          - failed
          - manualvalidationrequired
          
  messages:
    
    idpSubmissionKeys:
      traits:
        - $ref: '#/components/messageTraits/commonHeaders'
      payload:
        type: object
        properties:
          executionId:
            description: Unique Job Identifer from MuleSoft IDP 
            type: string
            format: uuid
          actionId:
            description: ActionId of IDP action that produced this callback
            type: string
            format: uuid
          actionVersion:
            description: Version of IDP action that produced this callback
            type: string
          msc:
            description: optional - key of a record like case id or email id
            type: string
        required:
          - executionId
          - actionId
          - actionVersion
        additionalProperties: false
      bindings:
        anypointmq:
          headers:
            type: object
            properties:
              messageId:
                type: string
          bindingVersion: latest

  messageTraits:
    commonHeaders:
      headers:
        type: object
        properties:
          correlationId:
            description: Correlation ID set by application
            type: string
            example: fty9a52d-e069-4441-83c6-8d779c937dd9
        correlationId:
          description: >-
            Correlation ID is specified as a header and transmitted in the
            Anypoint MQ message properties section
          location: $message.header#/correlationId

  securitySchemes:
    anypoint-oauth-prd:
      type: oauth2
      flows:
        clientCredentials:
          tokenUrl: 'https://mq-us-east-1.anypoint.mulesoft.com/api/v1/authorize'
          scopes: {}
    anypoint-oauth-dev:
      type: oauth2
      flows:
        clientCredentials:
          tokenUrl: 'https://mq-us-east-2.anypoint.mulesoft.com/api/v1/authorize'
          scopes: {}